name: Manual Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - feature
          - breaking

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: manual-release
      cancel-in-progress: false
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check and merge auto PR if exists
      uses: actions/github-script@v7
      id: check-pr
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: existingPRs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:main`,
            base: 'production',
            state: 'open'
          });
          
          if (existingPRs.length > 0) {
            const pr = existingPRs[0];
            console.log(`Found existing auto PR #${pr.number}`);
            
            // Check if PR can be merged
            if (pr.mergeable === false) {
              throw new Error(`Auto PR #${pr.number} has conflicts and cannot be merged automatically. Please resolve conflicts first.`);
            }
            
            // Try to merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'merge'
              });
              console.log(`Merged auto PR #${pr.number}`);
            } catch (error) {
              throw new Error(`Failed to merge auto PR #${pr.number}: ${error.message}`);
            }
            
            // Wait a bit for merge to complete
            await new Promise(resolve => setTimeout(resolve, 2000));
          } else {
            console.log('No existing auto PR found');
          }
          
    - name: Checkout production branch
      run: |
        git fetch origin production:production || git checkout -b production
        git checkout production
        
    - name: Get current version
      id: version
      run: |
        CURRENT_VERSION=$(grep "^Version:" debian/DEBIAN/control | awk '{print $2}')
        echo "Current version: $CURRENT_VERSION"
        
        # Calculate new version based on release type
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        if [ "${{ github.event.inputs.release_type }}" == "breaking" ]; then
          MAJOR=$((MAJOR + 1))
          MINOR=0
          PATCH=0
        elif [ "${{ github.event.inputs.release_type }}" == "feature" ]; then
          MINOR=$((MINOR + 1))
          PATCH=0
        fi
        
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION (${{ github.event.inputs.release_type }})"
        
    - name: Checkout main branch
      run: |
        git checkout main
        
    - name: Update version in control file
      run: |
        sed -i "s/^Version:.*/Version: ${{ steps.version.outputs.version }}/" debian/DEBIAN/control
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add debian/DEBIAN/control
        git commit -m "chore: bump version to ${{ steps.version.outputs.version }} (${{ github.event.inputs.release_type }})"
        git push origin main
        
    - name: Create PR to production
      uses: actions/github-script@v7
      id: create-pr
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: pr } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `chore: release version ${{ steps.version.outputs.version }} (${{ github.event.inputs.release_type }})`,
            head: 'main',
            base: 'production',
            body: `Manual release: ${{ github.event.inputs.release_type }} update to version ${{ steps.version.outputs.version }}`
          });
          
          console.log(`Created PR #${pr.number}`);
          return pr.number;
          
    - name: Wait for PR checks
      run: |
        sleep 5
        
    - name: Merge PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = ${{ steps.create-pr.outputs.result }};
          
          // Check if PR can be merged
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          if (pr.mergeable === false) {
            throw new Error(`PR #${prNumber} has conflicts and cannot be merged`);
          }
          
          await github.rest.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber,
            merge_method: 'merge'
          });
          
          console.log(`Merged PR #${prNumber}`);
          
    - name: Checkout production branch for release
      run: |
        git fetch origin production:production
        git checkout production
        
    - name: Create tag
      run: |
        git tag ${{ steps.version.outputs.tag }}
        git push origin ${{ steps.version.outputs.tag }}
        
    - name: Build Debian package
      run: |
        docker run --rm \
          --platform linux/amd64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ubuntu:22.04 \
          bash -c "
            apt-get update -qq
            apt-get install -y -qq dpkg-dev
            ./script/build-deb.sh
          "
          
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: build/*.deb
        tag_name: ${{ steps.version.outputs.tag }}
        name: luoking-box ${{ steps.version.outputs.version }}
        body: |
          ## luoking-box ${{ steps.version.outputs.version }}
          
          Release type: **${{ github.event.inputs.release_type }}**
          
          ### Installation
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/luoking-box_${{ steps.version.outputs.version }}_amd64.deb
          sudo apt install ./luoking-box_${{ steps.version.outputs.version }}_amd64.deb
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


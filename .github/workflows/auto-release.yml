name: Auto Release

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - production

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    concurrency:
      group: auto-release-pr
      cancel-in-progress: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Create or update PR to production
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('Starting PR creation/update process...');
          
          try {
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:main`,
              base: 'production',
              state: 'open'
            });
            
            console.log(`Found ${existingPRs.length} existing open PR(s)`);
            
            const prTitle = 'ðŸš€ Auto-release patch update [autogenerated]';
            const prBody = 'This PR is automatically generated for patch updates.\n\nThis PR contains patch updates for auto-release.';
            
            if (existingPRs.length > 0) {
              // Update existing PR
              const pr = existingPRs[0];
              console.log(`Updating existing PR #${pr.number}`);
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: prBody
              });
              console.log(`Successfully updated PR #${pr.number}`);
            } else {
              // Create new PR
              console.log('Creating new PR...');
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: 'main',
                base: 'production',
                body: prBody
              });
              console.log(`Successfully created PR #${pr.number}: ${pr.html_url}`);
            }
          } catch (error) {
            console.error('Error creating/updating PR:', error);
            throw error;
          }

  release:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.title, 'ðŸš€ Auto-release patch update [autogenerated]')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: production
        fetch-depth: 0
        
    - name: Get current version
      id: version
      run: |
        CURRENT_VERSION=$(grep "^Version:" debian/DEBIAN/control | awk '{print $2}')
        echo "Current version: $CURRENT_VERSION"
        
        # Increment patch version (1.0.0 -> 1.0.1)
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        PATCH=$((PATCH + 1))
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"
        
    - name: Update version in control file
      run: |
        sed -i "s/^Version:.*/Version: ${{ steps.version.outputs.version }}/" debian/DEBIAN/control
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add debian/DEBIAN/control
        git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
        git push origin production
        
    - name: Create tag
      run: |
        git tag ${{ steps.version.outputs.tag }}
        git push origin ${{ steps.version.outputs.tag }}
        
    - name: Build Debian package
      run: |
        docker run --rm \
          --platform linux/amd64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ubuntu:22.04 \
          bash -c "
            apt-get update -qq
            apt-get install -y -qq dpkg-dev
            ./script/build-deb.sh
          "
          
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: build/*.deb
        tag_name: ${{ steps.version.outputs.tag }}
        name: luoking-box ${{ steps.version.outputs.version }}
        body: |
          ## luoking-box ${{ steps.version.outputs.version }}
          
          ### Installation
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/luoking-box_${{ steps.version.outputs.version }}_amd64.deb
          sudo apt install ./luoking-box_${{ steps.version.outputs.version }}_amd64.deb
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


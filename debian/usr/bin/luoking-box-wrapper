#!/bin/bash
# luoking-box wrapper script
# Reads config.json to determine which configuration file to use

CONFIG_FILE="/etc/sing-box/config.json"
CONFIG_DIR="/etc/sing-box/sing-box-config"

# Check if config.json exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: $CONFIG_FILE not found" >&2
    exit 1
fi

# Read the active config name from config.json
# Expected format: {"active_config": "config-name"}
# Try to use python3 for JSON parsing if available, otherwise use grep
if command -v python3 >/dev/null 2>&1; then
    ACTIVE_CONFIG=$(python3 -c "import json, sys; print(json.load(sys.stdin)['active_config'])" < "$CONFIG_FILE" 2>/dev/null)
else
    # Fallback to grep method
    ACTIVE_CONFIG=$(grep -o '"active_config"[[:space:]]*:[[:space:]]*"[^"]*"' "$CONFIG_FILE" | cut -d'"' -f4)
fi

if [ -z "$ACTIVE_CONFIG" ]; then
    echo "Error: 'active_config' not found or invalid in $CONFIG_FILE" >&2
    exit 1
fi

# Construct the full path to the configuration file
SING_BOX_CONFIG="$CONFIG_DIR/$ACTIVE_CONFIG.json"

# Check if the configuration file exists
if [ ! -f "$SING_BOX_CONFIG" ]; then
    echo "Error: Configuration file not found: $SING_BOX_CONFIG" >&2
    echo "Please ensure the file exists in $CONFIG_DIR/" >&2
    exit 1
fi

# Execute sing-box with the selected configuration
exec /usr/bin/sing-box "$@" -c "$SING_BOX_CONFIG"


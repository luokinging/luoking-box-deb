#!/bin/bash
set -e

# Reload systemd after removal (skip if systemctl not available)
if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
    if command -v systemctl >/dev/null 2>&1 && systemctl >/dev/null 2>&1; then
        systemctl daemon-reload || true
    fi
fi

# Clean up proxy configurations and state files
if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
    # Remove Docker proxy configuration if exists
    if [ -f /etc/systemd/system/docker.service.d/http-proxy.conf ]; then
        echo "Removing Docker proxy configuration..."
        rm -f /etc/systemd/system/docker.service.d/http-proxy.conf || true
        # Reload systemd if docker service exists
        if command -v systemctl >/dev/null 2>&1 && systemctl >/dev/null 2>&1; then
            if systemctl list-units --type=service | grep -q docker.service; then
                systemctl daemon-reload || true
                echo "Note: Docker service may need to be restarted manually"
            fi
        fi
    fi

    # Remove state directory
    if [ -d /var/lib/luoking-box ]; then
        echo "Removing state directory /var/lib/luoking-box..."
        rm -rf /var/lib/luoking-box
    fi

    # Remove old wrapper script if exists (for compatibility)
    if [ -f /usr/bin/luoking-box-wrapper ]; then
        echo "Removing old wrapper script..."
        rm -f /usr/bin/luoking-box-wrapper || true
    fi
fi

# Remove config files and log directory only on purge
if [ "$1" = "purge" ]; then
    if [ -d /etc/luoking-box ]; then
        echo "Removing configuration directory /etc/luoking-box..."
        rm -rf /etc/luoking-box
    fi
    if [ -d /var/log/luoking-box ]; then
        echo "Removing log directory /var/log/luoking-box..."
        rm -rf /var/log/luoking-box
    fi
fi


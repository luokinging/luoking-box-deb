#!/bin/bash
set -e

# Reload systemd to recognize new services (skip if systemctl not available)
if command -v systemctl >/dev/null 2>&1 && systemctl >/dev/null 2>&1; then
    systemctl daemon-reload || true
    # Disable service by default (it should not auto-start)
    systemctl disable luoking-box.service >/dev/null 2>&1 || true
fi

# Create log directory
mkdir -p /var/log/luoking-box
chmod 755 /var/log/luoking-box

# Create sing-box-config directory if it doesn't exist
mkdir -p /etc/luoking-box/sing-box-config
chmod 755 /etc/luoking-box/sing-box-config

# Set permissions for config files (if they exist from package)
if [ -f /etc/luoking-box/config.json ]; then
    chmod 600 /etc/luoking-box/config.json
fi

if [ -f /etc/luoking-box/sing-box-config/default.json ]; then
    chmod 600 /etc/luoking-box/sing-box-config/default.json
fi

# Create default config.json if it doesn't exist (for upgrades)
if [ ! -f /etc/luoking-box/config.json ]; then
    echo '{"active_config": "default"}' > /etc/luoking-box/config.json
    chmod 600 /etc/luoking-box/config.json
    echo "Created default config.json at /etc/luoking-box/config.json"
fi

# Create default configuration file if it doesn't exist (for upgrades)
if [ ! -f /etc/luoking-box/sing-box-config/default.json ]; then
    cat > /etc/luoking-box/sing-box-config/default.json << 'EOF'
{
    "log": {
        "disabled": true,
        "level": "info",
        "timestamp": true
    },
    "dns": {
        "servers": [],
        "rules": [],
        "final": "",
        "strategy": "",
        "disable_cache": false,
        "disable_expire": false,
        "independent_cache": false,
        "cache_capacity": 0,
        "reverse_mapping": false
    },
    "inbounds": [],
    "outbounds": [],
    "route": {
        "rules": [],
        "rule_set": [],
        "default_domain_resolver": "",
        "final": "",
        "auto_detect_interface": false
    }
}
EOF
    chmod 600 /etc/luoking-box/sing-box-config/default.json
    echo "Created default configuration at /etc/luoking-box/sing-box-config/default.json"
    echo "Please configure it before starting the service."
fi

echo ""
echo "luoking-box has been installed successfully!"
echo ""
echo "To start the service (for local proxy):"
echo "  sudo systemctl start luoking-box"
echo ""
echo "Configuration files:"
echo "  Main config: /etc/luoking-box/config.json"
echo "  Config directory: /etc/luoking-box/sing-box-config/"
echo ""
echo "To switch configuration, edit /etc/luoking-box/config.json and change 'active_config'"
echo "then restart the service: sudo systemctl restart luoking-box"

